<!DOCTYPE html>
<html>
    <head>
        <meta charset = "UTF-8">
        <title>  </title>
        <link rel = "stylesheet" type = "text/css" href = "main.css">
    </head>
    <body>
        <h1>Welcome to INTERNET SHOP</h1>
        <p><span class = "page">메인페이지</span>&nbsp;
            <a href = "login.html">로그인</a>&nbsp;
            <a href = "signup.html">회원가입</a><hr class = "head">
        </p>
        <div>
            <aside>
                <form>
                    <div>&nbsp;&nbsp;&nbsp;Choose a category:<br>
                        <label><select id="category">
                            <option selected>All</option>
                            <option>CPU</option>
                            <option>MainBoard</option>
                            <option>GraphicsCard</option>
                        </select></label></div>
                    <div>&nbsp;&nbsp;&nbsp;Enter search term:<br>
                        <label><input type="text" id="searchTerm" placeholder="e.g. CPU"></label></div>
                    <div>&nbsp;&nbsp;&nbsp;<button>Filter results</button></div>
                </form>
            </aside>
            <main></main>
        </div>
        <script>
            fetch('product.json').then(function(response) {
                return response.json();})
                .then(function(json) {
                    let product = json;
                    initialize(product);})
                    .catch(function(err) {
                        console.log('Fetch problem: ' + err.message);});
                    function initialize(product) {
                        let category = document.querySelector('#category');
                        let searchTerm = document.querySelector('#searchTerm');
                        let searchButton = document.querySelector('button');
                        let main = document.querySelector('main');
                        let beforeCategory = category.value;
                        let beforeSearch = '';
                        let filtCategory;
                        let finalItem;
                        finalItem = product;
                        update();
                        filtCategory = [];
                        finalItem = [];
                        searchButton.onclick = selectCategory;
                        function update() {
                            while (main.firstChild) {
                                main.removeChild(main.firstChild);
                            }
                            if(finalItem.length === 0) {
                                let text = document.createElement('p');
                                text.textContent = 'No results!';
                                main.appendChild(text);
                            } else {
                                for(let i = 0; i < finalItem.length; i++) {
                                    let product = finalItem[i];
                                    showItem(product.image, product)
                                }
                            }
                        }
                        function showItem(imageroute, product) {
                            let section = document.createElement('section');
                            let span = document.createElement('span');
                            let image = document.createElement('img');
                            let head = document.createElement('h2');
                            let cost = document.createElement('p');
                            head.textContent = product.name;
                            cost.textContent = '$' + product.cost.toFixed(2);
                            section.setAttribute('class', product.category);
                            span.textContent = "Click to see more";
                            span.onclick = function() {
                                section.appendChild(head);
                                section.appendChild(cost);
                            }
                            image.src = imageroute;
                            image.alt = product.name;
                            main.appendChild(section);
                            section.appendChild(span);
                            section.appendChild(image);
                        }
                        function selectCategory(some) {
                            some.preventDefault();
                            filtCategory = [];
                            finalItem = [];
                            if(category.value === beforeCategory && searchTerm.value.trim() === beforeSearch) {
                                return;
                            } else {
                                beforeCategory = category.value;
                                beforeSearch = searchTerm.value.trim();
                                if(category.value === 'All') {
                                    filtCategory = product;
                                    filtItem();
                                } else {
                                    for(let i = 0; i < product.length ; i++) {
                                        if(product[i].category === category.value) {
                                            filtCategory.push(product[i]);
                                        }
                                    }
                                    filtItem();
                                }
                            }
                        }
                        function filtItem() {
                            let term = searchTerm.value.trim();
                            if(term === '') {
                                finalItem = filtCategory;
                                update();
                            } else {
                                for(let i = 0; i < filtCategory.length ; i++) {
                                    if(filtCategory[i].name.indexOf(term) !== -1) {
                                        finalItem.push(filtCategory[i]);
                                    }
                                }
                                update();
                            }
                        }
                    }
        </script>
    </body>
</html>